#!/usr/bin/env python

import sys
import argparse
import logging
from os import path
import os
sys.path.append("../lib")
from rpmController import rpm_api, mongo_api, comparer

def dinamic_call():
  rpms = rpm_api.Info()
  comp = comparer.Comparer()
  mongo = mongo_api.Info()
  return rpms, comp, mongo

def arguments():
  parser = argparse.ArgumentParser(prog='rpmController')
  parser.add_argument("-f", '--find', help="Pattern to search in MongoDB", type=str, metavar="pattern")
  parser.add_argument("-c", '--check', help="Check if there are new rpms in node", default=True, action='store_true')
  parser.add_argument("-d", '--debug', help="Debug Mode", default=True, action='store_true')
  parser.add_argument('--version', action='version', version='%(prog)s 0.1')
  return parser.parse_args()

def log(args):
  LOG_FILE = '../log/rpmController.log'
  logging.getLogger('').handlers = []
  if not os.path.exists(LOG_FILE):
    open(LOG_FILE, 'a').close()

  if args.debug:
    print "Debug Mode Activated"
    logging.basicConfig(
           filename=LOG_FILE,
           format='%(asctime)-15s %(name)-5s %(levelname)-8s %(message)s', 
           level=logging.DEBUG)
  else:
    logging.basicConfig(
           filename='../log/rpmController.log',
           format='%(asctime)-15s %(name)-5s %(levelname)-8s %(message)s',
           level=logging.ERROR) 

  logging.info('RPM Controller Started')

def check_all():
  try:
    logging.debug('Charging libraries in memory')
    rpms, comp, mongo = dinamic_call()

  except:
    logging.critical('Error making calls')
    raise

  info_host = {}
  packages = []
  try:
    info_host, packages = rpms.catcher()

  except:
    logging.critical('Error Catching RPMs from the node')
    raise

  print "- Checking database for New RPMs"
  logging.debug('Checking Database')
  try:
    mongo_packages = mongo.get_packages(comp.formatter(info_host['fqdn']))

  except:
    logging.critical('Error getting MongoDB packages of Node')
    raise

  try:
    logging.debug('Merging RPMs from System to MongoDB')
    merged_packages, updates = comp.merger(packages, mongo_packages, 'rpm', comp.formatter(info_host['fqdn']))

  except:
    logging.critical('Error Merging packages')


  if merged_packages != [] and updates == 0:
    ## Here we can log this entries for the following of the node ;)
    logging.debug('Database is empty, fullfilling')
    mongo.collection_maker(comp.formatter(info_host['fqdn']), info_host, merged_packages)

  elif updates > 0:
    logging.debug('- Packages updated: %d', updates)
    print "- Number of Updates in MongoDB: %d" % updates

  else:
    logging.debug('- There is not new RPMs in the Node')
    print "- There is not new RPMs in the Node"

  print "- Checking database for Deleted RPMs"
  logging.debug('- Checking database for Deleted RPMs')
  try:
    logging.debug('Mergging updates with MongoDB')
    updates = comp.merger(packages, mongo_packages, 'mongo', comp.formatter(info_host['fqdn']))

  except:
    logging.critical('Error mergging packages')

  if updates > 0:
    logging.debug('- Packages updated: %d', updates)
    print "- Number of Updates in MongoDB: %d" % updates

  else:
    logging.debug('- There is not new RPMs in the Node')
    print "- There is not RPMs erased in the Node"


## Arguments
args = arguments()
log(args)

if args.check and not args.find:
  print "Checking RPMS:"
  check_all()

elif args.find:
  print "Method in construction..."
  pass

else:
  print "Method in construction..."
