#!/usr/bin/env python

import sys
import argparse
from os import path
sys.path.append("../lib")
from rpmController import rpm_api, mongo_api, comparer

def dinamic_call():
  rpms = rpm_api.Info()
  comp = comparer.Comparer()
  mongo = mongo_api.Info()
  return rpms, comp, mongo

def arguments():
  parser = argparse.ArgumentParser(prog='rpmController')
  parser.add_argument("-f", '--find', help="Pattern to search in MongoDB", type=str, metavar="pattern")
  parser.add_argument("-c", '--check', help="Check if there are new rpms in node", default=True, action='store_true')
  parser.add_argument('--version', action='version', version='%(prog)s 0.1')
  return parser.parse_args()

def check_all():
  rpms, comp, mongo = dinamic_call()
  info_host = {}
  packages = []
  info_host, packages = rpms.catcher()

  print "- Checking database for New RPMs"
  mongo_packages = mongo.get_packages(comp.formatter(info_host['fqdn']))
  merged_packages, updates = comp.merger(packages, mongo_packages, 'rpm', comp.formatter(info_host['fqdn']))

  if merged_packages != [] and updates == 0:
    ## Here we can log this entries for the following of the node ;)
    mongo.collection_maker(comp.formatter(info_host['fqdn']), info_host, merged_packages)

  elif updates > 0:
    print "- Number of Updates in MongoDB: %d" % updates

  else:
    print "- There is not new RPMs in the Node"

  print "- Checking database for Deleted RPMs"
  updates = comp.merger(packages, mongo_packages, 'mongo', comp.formatter(info_host['fqdn']))

  if updates > 0:
    print "- Number of Updates in MongoDB: %d" % updates
  else:
    print "- There is not RPMs erased in the Node"


## Arguments
args = arguments()

if args.check and not args.find:
  print "Checking RPMS:"
  check_all()

elif args.find:
  print "Method in construction..."
  pass

else:
  print "Method in construction..."